<head>
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css">
<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.20/css/jquery.dataTables.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/1.6.1/css/buttons.dataTables.min.css">

<script src="https://code.jquery.com/jquery-3.3.1.js"></script>
<script src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/1.6.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/1.6.1/js/buttons.flash.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://cdn.datatables.net/buttons/1.6.1/js/buttons.html5.min.js"></script>

</head>

<body>
  <nav class="navbar navbar-default">
    <div class="container-fluid">
      <div class="navbar-header">
        <a class="navbar-brand" href="/index">Post45 Data</a>
      </div>
      <ul class="nav navbar-nav">
        <li><a href="/about">About</a></li>
        <li class="active"><a href="/index">Data</a></li>
      </ul>
    </div>
  </nav>
<div class="container-fluid">

<p style="font-size:18pt;">This table provides a preview of some of the variables in the Post45 dataset. To download the full dataset in a tab-delimited file, <a href="{% url 'download' %}">click here.</a></p>

<table id="record-table" class="stripe hover row-border" data-server-side="true" data-ajax="/records/?format=datatables">
  <thead>
    <tr>
    <th data-data="docid">docid</th>
    <th data-data="oldauthor">oldauthor</th>
    <th data-data="author">author</th>
      <th data-data="authordate">authordate</th>
      <th data-data="title">title</th>
      <th data-data="parttitle">parttitle</th>
      <th data-data="shorttitle">shorttitle</th>
      <th data-data="inferreddate">inferreddate</th>
      <th data-data="latestcomp">latestcomp</th>
      <th data-data="datetype">datetype</th>
      <th data-data="startdate">startdate</th>
      <th data-data="enddate">enddate</th>
      <th data-data="imprint">imprint</th>
      <th data-data="imprintdate">imprintdate</th>
      <th data-data="contents">contents</th>
      <th data-data="genres">genres</th>
      <th data-data="subjects">subjects</th>
      <th data-data="geographics">geographics</th>
      <th data-data="locnum">locnum</th>
      <th data-data="oclc">oclc</th>
      <th data-data="place">place</th>
      <th data-data="recordid">recordid</th>
      <th data-data="enumcron">enumcron</th>
      <th data-data="volnum">volnum</th>
      <th data-data="instances">instances</th>
      <th data-data="juvenileprob">juvenileprob</th>
      <th data-data="nonficprob">nonficprob</th>
      </tr>
        </thead>
        <!-- <tfoot>
          <tr>
            <th>docid</th>
            <th>oldauthor</th>
            <th>author</th>
              <th>authordate</th>
              <th>title</th>
              <th>parttitle</th>
              <th>shorttitle</th>
              <th>inferreddate</th>
              <th>latestcomp</th>
              <th>datetype</th>
              <th>startdate</th>
              <th>enddate</th>
              <th>imprint</th>
              <th>imprintdate</th>
              <th>contents</th>
              <th>genres</th>
              <th>subjects</th>
              <th>geographics</th>
              <th>locnum</th>
              <th>oclc</th>
              <th>place</th>
              <th>recordid</th>
              <th>enumcron</th>
              <th>volnum</th>
              <th>instances</th>
              <th>juvenileprob</th>
              <th>nonficprob</th>
          </tr>
          </tfoot> -->
</table>
</div>
</body>
<script>

    $(document).ready(function() {
      // Setup - add a text input to each header cell
       $('#record-table thead th').each( function () {
           var title = $(this).text();
           $(this).html( '<th>'+title+'<input type="text" placeholder="Search '+title+'" /></th>' );
       } );

    // DataTable
    var table = $('#record-table').DataTable( {

      //dom: 'lBfrtip',
      ajax: '/records/?format=datatables',
     //  buttons: [
     //      {
     //        extend: 'csv',
     //        text: 'Download full dataset',
     //        fieldSeparator: '\t',
     //        fieldBoundary: '',
     //        extension: '.tsv',
     //        action: function (e, dt, button, config)
     //                {
     //                    dt.one('preXhr', function (e, s, data)
     //                    {
     //                        data.length = -1;
     //                    }).one('draw', function (e, settings, json, xhr)
     //                    {
     //                        var excelButtonConfig = $.fn.DataTable.ext.buttons.excelHtml5;
     //                        var addOptions = { exportOptions: { 'columns': ':all'} };
     //
     //                        $.extend(true, excelButtonConfig, addOptions);
     //                        excelButtonConfig.action(e, dt, button, excelButtonConfig);
     //                    }).draw();
     //                }
     //      },
     //     {
     //         extend: 'csv',
     //         text: 'Download filtered dataset',
     //         fieldSeparator: '\t',
     //         fieldBoundary: '',
     //         extension: '.tsv',
     //         action: newExportAction,
     //         exportOptions: {
     //            modifier: {
     //              search: 'applied',
     //              order: 'applied'
     //            }
     //        }
     //     }
     // ],

    "iDisplayLength": 10,

    orderCellsTop: true,

    "columnDefs": [
            {
                "targets": [1, 4, 5, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21,  22, 23, 24, 25, 26],
                "visible": false,
                "searchable": false
            },
        ]
  } );

  // Apply the search
    table.columns().every( function () {
        var that = this;

        $( 'input', this.footer() ).on( 'keyup change clear', function () {
            if ( that.search() !== this.value ) {
                that
                    .search( this.value )
                    .draw();
            }
        } );
    } );
} );


// https://stackoverflow.com/a/44635032/2402028
var oldExportAction = function (self, e, dt, button, config) {
    if (button[0].className.indexOf('buttons-csv') >= 0) {
        if ($.fn.dataTable.ext.buttons.csvHtml5.available(dt, config)) {
            $.fn.dataTable.ext.buttons.csvHtml5.action.call(self, e, dt, button, config);
        }
        else {
            $.fn.dataTable.ext.buttons.csvFlash.action.call(self, e, dt, button, config);
        }
    } else if (button[0].className.indexOf('buttons-print') >= 0) {
        $.fn.dataTable.ext.buttons.print.action(e, dt, button, config);
    }
};

var newExportAction = function (e, dt, button, config) {
    var self = this;
    var oldStart = dt.settings()[0]._iDisplayStart;

    dt.one('preXhr', function (e, s, data) {
        // Just this once, load all data from the server...
        data.start = 0;
        data.length = 1000000;

        dt.one('preDraw', function (e, settings) {
            // Call the original action function
            oldExportAction(self, e, dt, button, config);

            dt.one('preXhr', function (e, s, data) {
                // DataTables thinks the first item displayed is index 0, but we're not drawing that.
                // Set the property to what it was before exporting.
                settings._iDisplayStart = oldStart;
                data.start = oldStart;
            });

            // Reload the grid with the original page. Otherwise, API functions like table.cell(this) don't work properly.
            setTimeout(dt.ajax.reload, 0);

            // Prevent rendering of the full data to the DOM
            return false;
        });
    });

    // Requery the server with the new one-time export settings
    dt.ajax.reload();
};


  </script>
